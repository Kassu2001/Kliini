<!DOCTYPE html>
<html>
  <head>
    <title>Kliini Sales Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      #map {
        height: 100%;
        width: 100%;
      }
      #statusButtons {
        position: absolute;
        top: 10px;
        right: 10px;
        display: none;
        flex-direction: column;
        gap: 8px;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px;
        border-radius: 12px;
        z-index: 5;
      }
      #statusButtons button {
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        color: white;
      }
      .sopimus { background-color: green; }
      .kiinnostunut { background-color: blue; }
      .ei-kotona { background-color: orange; }
      .ei-kiinnosta { background-color: red; }

      .bottom-nav {
        position: fixed;
        bottom: 0;
        width: 100%;
        background-color: #fff;
        display: flex;
        justify-content: space-around;
        padding: 10px 0;
        border-top: 1px solid #ccc;
        z-index: 5;
      }
      .bottom-nav a {
        text-decoration: none;
        color: black;
        font-size: 14px;
      }
      .bottom-nav a.active {
        color: red;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <div id="statusButtons">
      <button class="sopimus" onclick="submitForm('Sopimus')">üü¢ Sopimus</button>
      <button class="kiinnostunut" onclick="submitForm('Kiinnostunut')">üîπ Kiinnostunut</button>
      <button class="ei-kotona" onclick="submitForm('Ei kotona')">üü° Ei kotona</button>
      <button class="ei-kiinnosta" onclick="submitForm('Ei kiinnosta')">üî¥ Ei kiinnosta</button>
      <button onclick="clearManualPin()">‚ùå Peruuta</button>
    </div>

    <div class="bottom-nav">
      <a href="index.html">Home</a>
      <a href="map.html" class="active">Kliini</a>
      <a href="leads.html">Leads</a>
    </div>

    <script>
      let map;
      let manualMarker = null;
      let selectedLat = null;
      let selectedLng = null;

      const airtableReadEndpoint = "https://hook.eu2.make.com/YOUR-READ-HOOK"; // Replace
      const airtableWriteEndpoint = "https://hook.eu2.make.com/YOUR-WRITE-HOOK"; // Replace

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 60.1699, lng: 24.9384 },
          zoom: 13,
          gestureHandling: "greedy",
        });

        navigator.geolocation.getCurrentPosition((pos) => {
          const userPos = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
          };
          map.setCenter(userPos);
          new google.maps.Marker({ position: userPos, map, label: "Sin√§" });
        });

        map.addListener("click", (e) => {
          if (manualMarker) manualMarker.setMap(null);
          manualMarker = new google.maps.Marker({
            position: e.latLng,
            map: map,
            label: "ü´ã"
          });

          selectedLat = e.latLng.lat();
          selectedLng = e.latLng.lng();

          document.getElementById("statusButtons").style.display = "flex";
        });

        loadExistingPins();
      }

      function submitForm(status) {
        const email = localStorage.getItem("userEmail");
        if (!email || !selectedLat || !selectedLng) {
          alert("Puuttuva tieto. Varmista s√§hk√∂posti ja sijainti.");
          return;
        }

        const data = {
          email,
          status,
          lat: selectedLat,
          lng: selectedLng,
          timestamp: new Date().toISOString(),
        };

        fetch(airtableWriteEndpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        }).then(() => {
          alert("Tallennettu!");
          window.location.reload();
        }).catch(() => alert("Virhe l√§hetett√§ess√§"));
      }

      function clearManualPin() {
        if (manualMarker) manualMarker.setMap(null);
        manualMarker = null;
        selectedLat = null;
        selectedLng = null;
        document.getElementById("statusButtons").style.display = "none";
      }

      function loadExistingPins() {
        fetch(airtableReadEndpoint)
          .then(res => res.json())
          .then(data => {
            data.records.forEach((rec) => {
              const pos = { lat: rec.fields.lat, lng: rec.fields.lng };
              const color = rec.fields.status === "Sopimus" ? "green"
                         : rec.fields.status === "Kiinnostunut" ? "blue"
                         : rec.fields.status === "Ei kotona" ? "yellow"
                         : "red";

              new google.maps.Marker({
                position: pos,
                map,
                icon: {
                  path: google.maps.SymbolPath.CIRCLE,
                  scale: 8,
                  fillColor: color,
                  fillOpacity: 1,
                  strokeWeight: 1,
                },
              });
            });
          })
          .catch((err) => console.error("Failed loading pins:", err));
      }
    </script>

    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap">
    </script>
  </body>
</html>
